<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singularity Clicker: Evolution</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            margin: 0; background: radial-gradient(circle at center, #0a0a0a, #000);
            color: white; font-family: 'Segoe UI', sans-serif; display: flex;
            flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* ИНТЕРФЕЙС */
        #ui { margin-top: 100px; text-align: center; }
        #status { color: #00f2ff; opacity: 0.8; letter-spacing: 4px; text-transform: uppercase; font-size: 14px; margin-bottom: 5px; transition: 1s; }
        #energy { font-size: 64px; color: #fff; font-weight: 900; text-shadow: 0 0 20px #00f2ff; line-height: 1; }
        #cps-counter { color: #00ff88; font-size: 16px; margin-top: 10px; font-weight: bold; }
        
        /* КНОПКА ВНИЗУ */
        .boost-btn {
            position: absolute; bottom: 40px;
            padding: 15px 40px; border: none; border-radius: 50px;
            background: linear-gradient(45deg, #00f2ff, #0066ff);
            color: white; font-weight: bold; cursor: pointer; z-index: 10;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }
        #timer { color: #ff3300; font-weight: bold; font-size: 14px; margin-top: 5px; display: none; }

        #game { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; position: relative; }
        
        /* ФИГУРА */
        #shape {
            width: 110px; height: 110px; background: #00f2ff; border-radius: 50%;
            box-shadow: 0 0 40px #00f2ff; 
            transition: width 3s ease-in-out, height 3s ease-in-out, border-radius 3s ease-in-out, transform 0.05s, box-shadow 3s;
        }
        #shape.line { width: 280px; height: 12px; border-radius: 6px; box-shadow: 0 0 60px #00f2ff; }

        /* ЧАСТИЦЫ */
        .plus { 
            position: absolute; color: #00f2ff; font-weight: bold; font-size: 28px; 
            pointer-events: none; z-index: 50; text-shadow: 0 0 10px #00f2ff;
        }

        /* ЭФФЕКТ ПЕРЕХОДА */
        .evolving-text {
            position: absolute; top: 40%; color: white; font-weight: bold;
            letter-spacing: 10px; animation: blink 0.5s infinite; display: none;
        }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="ui">
        <div id="status">Point</div>
        <div id="energy">0</div>
        <div id="cps-counter">0 клик/с</div>
        <div id="timer">БУСТ: 00:30</div>
    </div>

    <div id="game">
        <div id="evolving" class="evolving-text">EVOLVING...</div>
        <div id="shape" onclick="tap(event)"></div>
    </div>

    <button class="boost-btn" onclick="openMath()">⚡ ACTIVATION BOOST</button>

    <div id="math-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100;">
        <div id="math-question" style="font-size:24px; margin-bottom:25px; color:#00f2ff;">...</div>
        <div id="math-input" style="font-size:36px; border:2px solid #00f2ff; width:220px; height:70px; display:flex; align-items:center; justify-content:center; margin-bottom:30px; background: rgba(0,242,255,0.1);"></div>
        <div style="display:grid; grid-template-columns:repeat(3, 80px); gap:15px;">
            <div onclick="press(1)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">1</div>
            <div onclick="press(2)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">2</div>
            <div onclick="press(3)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">3</div>
            <div onclick="press(4)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">4</div>
            <div onclick="press(5)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">5</div>
            <div onclick="press(6)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">6</div>
            <div onclick="press(7)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">7</div>
            <div onclick="press(8)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">8</div>
            <div onclick="press(9)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">9</div>
            <div onclick="press('C')" style="width:80px; height:70px; background:#f44; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">C</div>
            <div onclick="press(0)" style="width:80px; height:70px; background:#222; display:flex; align-items:center; justify-content:center; font-size:28px; border-radius:10px;">0</div>
            <div onclick="checkAnswer()" style="width:80px; height:70px; background:#00f2ff; color:black; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; border-radius:10px;">OK</div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const firebaseConfig = { databaseURL: "https://singularityclicker-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let energy = 0, level = 0, autoClickActive = false, correctAnswer = 0;
    let manualClicksThisSecond = 0;
    let isTransitioning = false; // Блокировка кликов

    const energyEl = document.getElementById("energy");
    const shape = document.getElementById("shape");
    const statusEl = document.getElementById("status");

    function loadData() {
        const user = tg.initDataUnsafe?.user;
        if(user) {
            db.ref('users/' + user.id).once('value').then(s => {
                const data = s.val();
                if(data) {
                    energy = data.s || 0;
                    level = data.l || 0;
                    energyEl.textContent = energy;
                    if(level >= 1) { shape.classList.add("line"); statusEl.textContent = "Line"; }
                }
            });
        }
    }
    loadData();

    function tap(e) {
        if(isTransitioning) return; // Запрет клика при переходе

        const gain = (level === 0) ? 1 : 2;
        energy += gain;
        manualClicksThisSecond += gain;
        energyEl.textContent = energy;
        
        shape.style.transform = "scale(0.85)";
        setTimeout(() => shape.style.transform = "scale(1)", 50);
        
        showPlus(gain, e.clientX, e.clientY);
        tg.HapticFeedback.impactOccurred("medium");

        if (energy >= 1000 && level === 0) {
            startEvolution();
        }
    }

    function showPlus(val, x, y) {
        const p = document.createElement("div");
        p.className = "plus";
        p.textContent = "+" + val;
        p.style.left = x + "px";
        p.style.top = y + "px";
        document.body.appendChild(p);

        // Увеличен радиус разлета
        const randomX = (Math.random() - 0.5) * 300; // Разлет на 150px влево или вправо
        const randomY = -200 - (Math.random() * 100); // Разлет вверх на 200-300px

        p.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${randomX}px, ${randomY}px) scale(1.5)`, opacity: 0 }
        ], { duration: 1000, easing: 'ease-out' });
        
        setTimeout(() => p.remove(), 1000);
    }

    function startEvolution() {
        isTransitioning = true;
        autoClickActive = false; // Отключаем буст если он был
        level = 1;
        
        document.getElementById("evolving").style.display = "block";
        shape.style.boxShadow = "0 0 150px #00f2ff";
        
        setTimeout(() => {
            shape.classList.add("line");
            statusEl.textContent = "Line";
            statusEl.style.fontSize = "24px";
        }, 100);

        setTimeout(() => {
            isTransitioning = false;
            document.getElementById("evolving").style.display = "none";
            statusEl.style.fontSize = "14px";
            save();
            tg.HapticFeedback.notificationOccurred("success");
        }, 3000); // Длительность перехода 3 секунды
    }

    setInterval(() => {
        let totalCPS = manualClicksThisSecond;
        if(autoClickActive && !isTransitioning) totalCPS += 10;
        document.getElementById("cps-counter").textContent = Math.round(totalCPS) + " клик/с";
        manualClicksThisSecond = 0;
    }, 1000);

    setInterval(() => {
        if(autoClickActive && !isTransitioning) {
            energy += 1;
            energyEl.textContent = energy;
            if (energy >= 1000 && level === 0) startEvolution();
        }
    }, 100);

    function openMath() {
        if(autoClickActive || isTransitioning) return;
        let a = Math.floor(Math.random()*20)+10, b = Math.floor(Math.random()*8)+3;
        document.getElementById("math-question").textContent = `${a} * ${b} - 12 = ?`;
        correctAnswer = (a * b) - 12;
        document.getElementById("math-input").textContent = "";
        document.getElementById("math-overlay").style.display = "flex";
    }

    function press(v) {
        if(v==='C') document.getElementById("math-input").textContent = "";
        else if(document.getElementById("math-input").textContent.length < 6) 
             document.getElementById("math-input").textContent += v;
    }

    function checkAnswer() {
        if(parseInt(document.getElementById("math-input").textContent) === correctAnswer) {
            document.getElementById("math-overlay").style.display = "none";
            autoClickActive = true;
            let timeLeft = 30;
            const timerEl = document.getElementById("timer");
            timerEl.style.display = "block";
            let bInt = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `БУСТ: 00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if(timeLeft <= 0 || isTransitioning) {
                    clearInterval(bInt);
                    autoClickActive = false;
                    timerEl.style.display = "none";
                }
            }, 1000);
        } else {
            tg.showAlert("Данные не верны!");
            openMath();
        }
    }

    function save() {
        const user = tg.initDataUnsafe?.user;
        if(user && !isTransitioning) {
            db.ref('users/' + user.id).update({ n: user.first_name, s: energy, l: level });
        }
    }
    setInterval(save, 7000);
</script>
</body>
</html>