<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singularity: Blue Edition</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            margin: 0; background: radial-gradient(circle at center, #001529, #000);
            color: #e0f7ff; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex;
            flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* UI ELEMENTS */
        #ui { margin-top: 80px; text-align: center; z-index: 10; }
        #status { color: #00d2ff; opacity: 0.8; letter-spacing: 5px; text-transform: uppercase; font-size: 14px; margin-bottom: 8px; }
        #energy { font-size: 68px; color: #fff; font-weight: 900; text-shadow: 0 0 25px #00d2ff; line-height: 1; }
        #cps-counter { color: #00d2ff; font-size: 16px; margin-top: 10px; font-weight: bold; opacity: 0.9; }
        
        /* TIMER */
        #timer { color: #fff; background: rgba(0, 210, 255, 0.2); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-top: 10px; display: none; border: 1px solid #00d2ff; }

        /* BOOST BUTTON */
        .boost-btn {
            position: absolute; bottom: 40px;
            padding: 18px 50px; border: none; border-radius: 50px;
            background: linear-gradient(135deg, #00d2ff, #0072ff);
            color: white; font-size: 16px; font-weight: bold; cursor: pointer; z-index: 10;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.5); text-transform: uppercase; letter-spacing: 1px;
        }

        #game { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; position: relative; }
        
        /* THE SHAPE */
        #shape {
            width: 120px; height: 120px; background: #00d2ff; border-radius: 50%;
            box-shadow: 0 0 50px #00d2ff, inset 0 0 20px #fff; 
            transition: width 3s ease-in-out, height 3s ease-in-out, border-radius 3s ease-in-out, transform 0.05s;
        }
        #shape.line { width: 280px; height: 12px; border-radius: 6px; box-shadow: 0 0 60px #00d2ff; }

        /* PARTICLES */
        .plus { 
            position: absolute; color: #fff; font-weight: bold; font-size: 28px; 
            pointer-events: none; z-index: 50; text-shadow: 0 0 15px #00d2ff;
        }

        /* EVOLUTION OVERLAY */
        .evolving-text {
            position: absolute; top: 40%; color: #00d2ff; font-weight: bold;
            letter-spacing: 10px; animation: blink 0.6s infinite; display: none; font-size: 20px;
        }
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* MATH OVERLAY */
        #math-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 10, 20, 0.98); display: none; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        #math-question { font-size: 26px; margin-bottom: 30px; color: #00d2ff; font-weight: bold; }
        #math-input {
            font-size: 40px; border: 2px solid #00d2ff; width: 240px; height: 80px; 
            display: flex; align-items: center; justify-content: center; margin-bottom: 40px; 
            background: rgba(0, 210, 255, 0.1); color: #fff; border-radius: 15px;
        }
        .key-grid { display: grid; grid-template-columns: repeat(3, 85px); gap: 15px; }
        .key {
            width: 85px; height: 75px; background: #002b4d; color: #fff; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; border-radius: 15px; border: 1px solid #004e8c;
        }
        .key:active { background: #00d2ff; color: #000; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="status">Point</div>
        <div id="energy">0</div>
        <div id="cps-counter">0 clicks/s</div>
        <div id="timer">BOOST: 00:30</div>
    </div>

    <div id="game">
        <div id="evolving" class="evolving-text">EVOLVING...</div>
        <div id="shape" onclick="tap(event)"></div>
    </div>

    <button class="boost-btn" onclick="openMath()">âš¡ ACTIVATE BOOST</button>

    <div id="math-overlay">
        <div id="math-question">...</div>
        <div id="math-input"></div>
        <div class="key-grid">
            <div class="key" onclick="press(1)">1</div><div class="key" onclick="press(2)">2</div><div class="key" onclick="press(3)">3</div>
            <div class="key" onclick="press(4)">4</div><div class="key" onclick="press(5)">5</div><div class="key" onclick="press(6)">6</div>
            <div class="key" onclick="press(7)">7</div><div class="key" onclick="press(8)">8</div><div class="key" onclick="press(9)">9</div>
            <div class="key" style="background:#6a0000" onclick="press('C')">C</div><div class="key" onclick="press(0)">0</div>
            <div class="key" style="background:#00d2ff; color:#000; font-size:20px; font-weight:bold;" onclick="checkAnswer()">OK</div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const firebaseConfig = { databaseURL: "https://singularityclicker-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let energy = 0, level = 0, autoClickActive = false, correctAnswer = 0;
    let manualClicksThisSecond = 0;
    let isTransitioning = false;

    const energyEl = document.getElementById("energy");
    const shape = document.getElementById("shape");
    const statusEl = document.getElementById("status");

    function loadData() {
        const user = tg.initDataUnsafe?.user;
        if(user) {
            db.ref('users/' + user.id).once('value').then(s => {
                const data = s.val();
                if(data) {
                    energy = data.s || 0; level = data.l || 0;
                    energyEl.textContent = energy;
                    if(level >= 1) { shape.classList.add("line"); statusEl.textContent = "Line"; }
                }
            });
        }
    }
    loadData();

    function tap(e) {
        if(isTransitioning) return;
        const gain = (level === 0) ? 1 : 2;
        energy += gain;
        manualClicksThisSecond += gain;
        energyEl.textContent = energy;
        
        shape.style.transform = "scale(0.85)";
        setTimeout(() => shape.style.transform = "scale(1)", 50);
        
        spawnParticle(gain, e.clientX, e.clientY);
        tg.HapticFeedback.impactOccurred("medium");

        if (energy >= 1000 && level === 0) startEvolution();
    }

    // Main particle function
    function spawnParticle(val, x, y) {
        const p = document.createElement("div");
        p.className = "plus";
        p.textContent = "+" + val;
        p.style.left = x + "px";
        p.style.top = y + "px";
        document.body.appendChild(p);

        const randomX = (Math.random() - 0.5) * 250;
        const randomY = -150 - (Math.random() * 100);

        p.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${randomX}px, ${randomY}px) scale(1.8)`, opacity: 0 }
        ], { duration: 900, easing: 'ease-out' });
        
        setTimeout(() => p.remove(), 900);
    }

    // Auto-particle for Boost mode
    function spawnAutoParticle() {
        const rect = shape.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        spawnParticle(1, centerX, centerY);
    }

    function startEvolution() {
        isTransitioning = true;
        autoClickActive = false;
        level = 1;
        document.getElementById("evolving").style.display = "block";
        shape.style.boxShadow = "0 0 150px #00d2ff";
        
        setTimeout(() => {
            shape.classList.add("line");
            statusEl.textContent = "Line";
        }, 100);

        setTimeout(() => {
            isTransitioning = false;
            document.getElementById("evolving").style.display = "none";
            save();
            tg.HapticFeedback.notificationOccurred("success");
        }, 3000);
    }

    setInterval(() => {
        let totalCPS = manualClicksThisSecond;
        if(autoClickActive && !isTransitioning) totalCPS += 10;
        document.getElementById("cps-counter").textContent = Math.round(totalCPS) + " clicks/s";
        manualClicksThisSecond = 0;
    }, 1000);

    // Boost Tick (0.1s)
    setInterval(() => {
        if(autoClickActive && !isTransitioning) {
            energy += (level === 0) ? 1 : 2;
            energyEl.textContent = energy;
            spawnAutoParticle(); // Particles during boost
            if (energy >= 1000 && level === 0) startEvolution();
        }
    }, 100);

    function openMath() {
        if(autoClickActive || isTransitioning) return;
        let a = Math.floor(Math.random()*20)+10, b = Math.floor(Math.random()*9)+2;
        document.getElementById("math-question").textContent = `${a} * ${b} - 8 = ?`;
        correctAnswer = (a * b) - 8;
        document.getElementById("math-input").textContent = "";
        document.getElementById("math-overlay").style.display = "flex";
    }

    function press(v) {
        if(v==='C') document.getElementById("math-input").textContent = "";
        else if(document.getElementById("math-input").textContent.length < 6) 
             document.getElementById("math-input").textContent += v;
    }

    function checkAnswer() {
        if(parseInt(document.getElementById("math-input").textContent) === correctAnswer) {
            document.getElementById("math-overlay").style.display = "none";
            autoClickActive = true;
            let timeLeft = 30;
            const timerEl = document.getElementById("timer");
            timerEl.style.display = "inline-block";
            let bInt = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `BOOST: 00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if(timeLeft <= 0 || isTransitioning) {
                    clearInterval(bInt);
                    autoClickActive = false;
                    timerEl.style.display = "none";
                }
            }, 1000);
        } else {
            tg.showAlert("Calculation Error!");
            openMath();
        }
    }

    function save() {
        const user = tg.initDataUnsafe?.user;
        if(user && !isTransitioning) {
            db.ref('users/' + user.id).update({ n: user.first_name, s: energy, l: level });
        }
    }
    setInterval(save, 8000);
</script>
</body>
</html>