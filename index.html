<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singularity Math Clicker</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            margin: 0; background: radial-gradient(circle at center, #080808, #000);
            color: white; font-family: sans-serif; display: flex;
            flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; user-select: none;
        }

        /* ИНТЕРФЕЙС */
        #ui { margin-top: 80px; text-align: center; }
        #energy { font-size: 60px; color: #00f2ff; text-shadow: 0 0 20px #00f2ff; font-weight: bold; }
        
        .boost-btn {
            position: absolute; top: 15px; right: 15px;
            padding: 12px 18px; border: none; border-radius: 12px;
            background: linear-gradient(45deg, #00f2ff, #0066ff);
            color: white; font-weight: bold; cursor: pointer; z-index: 10;
        }

        #timer { color: #ff9d00; font-weight: bold; margin-top: 5px; display: none; }

        /* КЛАВИАТУРА (Оверлей) */
        #math-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        #math-question { font-size: 24px; margin-bottom: 20px; color: #00f2ff; text-align: center; }
        #math-input {
            font-size: 32px; background: rgba(255,255,255,0.1); border: 2px solid #00f2ff;
            border-radius: 10px; width: 200px; text-align: center; margin-bottom: 20px; padding: 10px;
        }
        .keyboard {
            display: grid; grid-template-columns: repeat(3, 70px); gap: 10px;
        }
        .key {
            width: 70px; height: 70px; background: rgba(255,255,255,0.1);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
        }
        .key:active { background: #00f2ff; color: black; }
        .key.wide { grid-column: span 2; width: 150px; background: #0066ff; }
        .key.clear { background: #ff4444; }

        /* ИГРА */
        #game { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; }
        #shape { width: 100px; height: 100px; background: #00f2ff; border-radius: 50%; box-shadow: 0 0 30px #00f2ff; }
        #shape.line { width: 260px; height: 15px; border-radius: 10px; }
    </style>
</head>
<body>

    <button class="boost-btn" onclick="openMath()">⚡ РЕШИТЬ ПРИМЕР</button>
    <div id="ui">
        <div id="energy">0</div>
        <div id="timer">05:00</div>
    </div>

    <div id="game"><div id="shape" onclick="tap()"></div></div>

    <div id="math-overlay">
        <div id="math-question">Пример</div>
        <div id="math-input"></div>
        <div class="keyboard">
            <div class="key" onclick="press(1)">1</div><div class="key" onclick="press(2)">2</div><div class="key" onclick="press(3)">3</div>
            <div class="key" onclick="press(4)">4</div><div class="key" onclick="press(5)">5</div><div class="key" onclick="press(6)">6</div>
            <div class="key" onclick="press(7)">7</div><div class="key" onclick="press(8)">8</div><div class="key" onclick="press(9)">9</div>
            <div class="key clear" onclick="press('C')">C</div><div class="key" onclick="press(0)">0</div><div class="key" onclick="press('-')">-</div>
            <div class="key wide" onclick="checkAnswer()">ОТВЕТИТЬ</div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const firebaseConfig = { databaseURL: "https://singularityclicker-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let energy = 0, level = 0, autoClickPower = 0, correctAnswer = 0;
    const energyEl = document.getElementById("energy");
    const shape = document.getElementById("shape");
    const mathInput = document.getElementById("math-input");

    /* КЛИК */
    function tap() {
        const gain = (level === 0) ? 1 : 5;
        energy += gain;
        energyEl.textContent = Math.floor(energy);
        shape.style.transform = "scale(0.9)";
        setTimeout(() => shape.style.transform = "scale(1)", 50);
        if (energy >= 1000 && level === 0) { level = 1; shape.classList.add("line"); }
    }

    /* ЛОГИКА КЛАВИАТУРЫ */
    function openMath() {
        if(autoClickPower > 0) return tg.showAlert("Буст уже активен!");
        
        // Генерация примера
        const types = ['percent', 'root', 'equation'];
        const type = types[Math.floor(Math.random() * types.length)];
        
        if (type === 'percent') {
            let v = (Math.floor(Math.random()*10)+1)*20;
            let p = 15; 
            document.getElementById("math-question").textContent = `Сколько будет ${p}% от ${v}?`;
            correctAnswer = (v * p) / 100;
        } else if (type === 'root') {
            let roots = [144, 169, 225, 256, 400];
            let r = roots[Math.floor(Math.random()*roots.length)];
            document.getElementById("math-question").textContent = `Квадратный корень из ${r}?`;
            correctAnswer = Math.sqrt(r);
        } else {
            let x = Math.floor(Math.random()*30)+5;
            let b = Math.floor(Math.random()*50)+10;
            document.getElementById("math-question").textContent = `Найди X: X + ${b} = ${x + b}`;
            correctAnswer = x;
        }

        mathInput.textContent = "";
        document.getElementById("math-overlay").style.display = "flex";
    }

    function press(key) {
        if (key === 'C') mathInput.textContent = "";
        else if (mathInput.textContent.length < 6) mathInput.textContent += key;
        tg.HapticFeedback.impactOccurred("light");
    }

    function checkAnswer() {
        if (parseFloat(mathInput.textContent) === correctAnswer) {
            document.getElementById("math-overlay").style.display = "none";
            startBoost();
            tg.HapticFeedback.notificationOccurred("success");
        } else {
            tg.showAlert("Неверно! Попробуй другой пример.");
            openMath(); // Генерируем новый при ошибке
        }
    }

    function startBoost() {
        autoClickPower = 2;
        let timeLeft = 300;
        const timerEl = document.getElementById("timer");
        timerEl.style.display = "block";
        
        let interval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60), s = timeLeft%60;
            timerEl.textContent = `${m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) {
                clearInterval(interval);
                autoClickPower = 0;
                timerEl.style.display = "none";
            }
        }, 1000);
    }

    setInterval(() => { if(autoClickPower > 0) { energy += autoClickPower; energyEl.textContent = Math.floor(energy); } }, 1000);

    /* СОХРАНЕНИЕ */
    function save() {
        const user = tg.initDataUnsafe?.user;
        if(user) db.ref('users/' + user.id).update({ n: user.first_name, s: Math.floor(energy), l: level });
    }
    setInterval(save, 10000);
</script>
</body>
</html>