<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singularity Clicker</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://adsgram.ai/sdk/v1/adsgram-sdk.js"></script>

    <style>
        body {
            margin: 0; background: radial-gradient(circle at center, #080808, #000);
            color: white; font-family: sans-serif; display: flex;
            flex-direction: column; align-items: center; height: 100vh;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #leaderboard {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 255, 255, 0.05); padding: 10px;
            border-radius: 12px; font-size: 11px; z-index: 20;
            border: 1px solid rgba(0, 242, 255, 0.2); backdrop-filter: blur(5px);
        }

        .ads-container {
            position: absolute; top: 10px; right: 10px;
            display: flex; flex-direction: column; align-items: flex-end; z-index: 20;
        }

        .buy-btn {
            padding: 10px 16px; border: none; border-radius: 12px;
            font-weight: bold; background: linear-gradient(45deg, #00f2ff, #0066ff);
            color: white; cursor: pointer; box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
            transition: transform 0.1s;
        }
        .buy-btn:active { transform: scale(0.9); }

        #timer { font-size: 12px; color: #ff9d00; margin-top: 5px; display: none; font-weight: bold; }

        #ui { margin-top: 100px; text-align: center; pointer-events: none; }
        #energy { font-size: 64px; color: #00f2ff; font-weight: 900; text-shadow: 0 0 20px #00f2ff; }
        #status { opacity: 0.6; letter-spacing: 3px; text-transform: uppercase; margin-top: -5px; }

        #game { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; }
        #shape {
            width: 100px; height: 100px; background: #00f2ff;
            border-radius: 50%; box-shadow: 0 0 40px #00f2ff;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), transform 0.1s;
        }
        #shape.line { width: 260px; height: 15px; border-radius: 10px; box-shadow: 0 0 60px #00f2ff; }

        .plus { position: absolute; color: #00f2ff; font-weight: bold; font-size: 24px; pointer-events: none; z-index: 10; }
    </style>
</head>
<body>

    <div id="leaderboard">
        <strong>TOP PLAYERS</strong>
        <div id="list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="ads-container">
        <button class="buy-btn" onclick="showAd()">AUTO x2 (5 –ú–ò–ù üì∫)</button>
        <div id="timer">05:00</div>
    </div>

    <div id="ui">
        <div id="energy">0</div>
        <div id="status">Point</div>
    </div>

    <div id="game">
        <div id="shape" onclick="tap()"></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // –¢–í–û–ò –î–ê–ù–ù–´–ï
    const adsBlockId = "22216"; 
    const firebaseURL = "https://singularityclicker-default-rtdb.firebaseio.com/";

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Adsgram
    const AdController = window.Adsgram.init({ blockId: adsBlockId });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    try {
        firebase.initializeApp({ databaseURL: firebaseURL });
        var db = firebase.database();
    } catch(e) { console.error("Firebase error"); }

    let energy = 0;
    let level = 0;
    let autoClickPower = 0;
    let bonusTimer = null;
    let isEvolving = false;

    const energyEl = document.getElementById("energy");
    const shape = document.getElementById("shape");
    const timerEl = document.getElementById("timer");

    function tap() {
        if (isEvolving) return;
        const gain = (level === 0) ? 1 : 5;
        addEnergy(gain);
        
        shape.style.transform = "scale(0.88)";
        setTimeout(() => shape.style.transform = "scale(1)", 50);
        
        showPlus(gain);
        tg.HapticFeedback.impactOccurred("medium");

        if (energy >= 1000 && level === 0) {
            evolve();
        }
    }

    function addEnergy(val) {
        energy += val;
        energyEl.textContent = Math.floor(energy);
    }

    function evolve() {
        isEvolving = true;
        level = 1;
        document.getElementById("status").textContent = "Line";
        shape.style.boxShadow = "0 0 100px #fff";
        setTimeout(() => {
            shape.classList.add("line");
            isEvolving = false;
            save();
        }, 300);
    }

    function showAd() {
        AdController.show().then(() => {
            activateBonus();
        }).catch(() => {
            tg.showAlert("–†–µ–∫–ª–∞–º–∞ –Ω–µ –¥–æ—Å–º–æ—Ç—Ä–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!");
        });
    }

    function activateBonus() {
        autoClickPower = 2;
        let timeLeft = 300;
        timerEl.style.display = "block";

        if(bonusTimer) clearInterval(bonusTimer);
        bonusTimer = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft/60);
            let s = timeLeft % 60;
            timerEl.textContent = `–ê–∫—Ç–∏–≤–Ω–æ: ${m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) {
                clearInterval(bonusTimer);
                autoClickPower = 0;
                timerEl.style.display = "none";
                tg.showAlert("–ë–æ–Ω—É—Å —Ö2 –∑–∞–≤–µ—Ä—à–µ–Ω!");
            }
        }, 1000);
    }

    // –¶–∏–∫–ª –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–∞
    setInterval(() => {
        if(autoClickPower > 0 && !isEvolving) {
            addEnergy(autoClickPower);
        }
    }, 1000);

    function showPlus(val) {
        const p = document.createElement("div");
        p.className = "plus"; p.textContent = "+"+val;
        const rect = shape.getBoundingClientRect();
        p.style.left = (rect.left + rect.width/2) + "px";
        p.style.top = rect.top + "px";
        document.body.appendChild(p);
        p.animate([{transform:"translate(-50%, 0)", opacity:1}, {transform:"translate(-50%, -80px)", opacity:0}], 800);
        setTimeout(() => p.remove(), 800);
    }

    function save() {
        const user = tg.initDataUnsafe?.user;
        if(user && db) {
            db.ref('users/' + user.id).update({
                n: user.first_name || "Anon",
                s: Math.floor(energy),
                l: level
            });
        }
    }

    function loadLeaderboard() {
        if (db) {
            db.ref('users').orderByChild('s').limitToLast(5).on('value', snap => {
                const list = [];
                snap.forEach(s => { list.push(s.val()); });
                list.sort((a,b) => b.s - a.s);
                document.getElementById("list").innerHTML = list.map((p,i) => `<div>${i+1}. ${p.n}: ${p.s}</div>`).join('');
            });
        }
    }

    loadLeaderboard();
    setInterval(save, 10000);
</script>
</body>
</html>
